---
import BaseLayout from "./BaseLayout.astro";
import { getCollection } from "astro:content";

const { title, description, pubDate, category, slug } = Astro.props;

const site = "https://novaraiz.netlify.app";
const canonical = `${site}/blog/${slug}`;

const allPosts = (await getCollection("blog")).filter((p) => !p.data.draft);
const related = allPosts
  .filter((p) => p.data.category === category && p.slug !== slug)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "datePublished": pubDate instanceof Date ? pubDate.toISOString() : pubDate,
  "mainEntityOfPage": canonical,
  "url": canonical,
  "author": {
    "@type": "Organization",
    "name": "Nova Raiz",
    "url": site
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nova Raiz",
    "url": site
  }
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Início", "item": `${site}/` },
    { "@type": "ListItem", "position": 2, "name": "Blog", "item": `${site}/blog` },
    { "@type": "ListItem", "position": 3, "name": title, "item": canonical }
  ]
};
---

<BaseLayout title={`${title} — Nova Raiz`} description={description} canonical={canonical}>
  <article class="py-10 md:py-14">
    <div class="mx-auto" style="max-width: var(--contentw);">
      <nav aria-label="Breadcrumb" class="text-sm" style="color: var(--muted);">
        <ol class="flex flex-wrap items-center gap-2">
          <li><a class="underline" href="/">Início</a></li>
          <li aria-hidden="true">›</li>
          <li><a class="underline" href="/blog">Blog</a></li>
          <li aria-hidden="true">›</li>
          <li><span class="font-semibold" style="color: var(--text);">{title}</span></li>
        </ol>
      </nav>

      <div class="mt-6 text-xs font-semibold uppercase tracking-wide" style="color: var(--muted);">{category}</div>
      <h1 class="mt-2 text-4xl md:text-5xl leading-tight" style="font-family:'Playfair Display', serif;">
        {title}
      </h1>
      <p class="mt-4 text-lg leading-relaxed" style="color: var(--muted);">{description}</p>
      <div class="mt-6 text-xs" style="color: var(--muted);">
        {pubDate.toLocaleDateString("pt-BR")}
      </div>

      <div class="prose prose-lg mt-10 max-w-none"
        style="--tw-prose-body: var(--text); --tw-prose-headings: var(--text); --tw-prose-links: var(--primary);">
        <slot />
      </div>

      {related.length > 0 && (
        <section class="mt-14 rounded-3xl border p-6 md:p-8"
          style="border-color: var(--border); background: var(--surface);">
          <div class="text-sm font-semibold" style="color: var(--muted);">Continue lendo</div>
          <ul class="mt-4 space-y-3 text-sm">
            {related.map((r) => (
              <li>
                <a class="underline" href={`/blog/${r.slug}`}>{r.data.title}</a>
              </li>
            ))}
          </ul>
        </section>
      )}
    </div>

    <script type="application/ld+json">
      {JSON.stringify(articleJsonLd)}
    </script>
    <script type="application/ld+json">
      {JSON.stringify(breadcrumbJsonLd)}
    </script>
  </article>
</BaseLayout>
