---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { COMPARATIVAS } from "../../data/comparativas";

// city-stats is generated at build time by scripts/buildCityStats.mjs
import cityStatsData from "../../generated/city-stats.json";

export async function getStaticPaths() {
  return COMPARATIVAS.map((c) => ({ params: { slug: c.slug } }));
}

const { slug } = Astro.params;
const c = COMPARATIVAS.find((x) => x.slug === slug);
if (!c) throw new Error(`Comparativa não encontrada: ${slug}`);

const title = c.title;
const description = c.description;

const A = c.a;
const B = c.b;

const normalize = (s) =>
  String(s || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();

const key = (city) => `${normalize(city.name)}|${city.uf}`;
const stats = cityStatsData?.stats || {};

const cityA = stats[key(A)] || null;
const cityB = stats[key(B)] || null;

const fmt = (v) => (v === 0 ? "0" : v ? String(v) : "—");
const fmtNum = (v, digits = 2) => (typeof v === "number" && Number.isFinite(v) ? v.toFixed(digits) : fmt(v));
const fmtMoney = (v) => (typeof v === "number" && Number.isFinite(v) ? `R$ ${v.toLocaleString("pt-BR")}` : fmt(v));

const url = `https://novaraiz.netlify.app/comparativas/${c.slug}/`;

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: "https://novaraiz.netlify.app/" },
    { "@type": "ListItem", position: 2, name: "Comparativas", item: "https://novaraiz.netlify.app/comparativas/" },
    { "@type": "ListItem", position: 3, name: `${A.name} vs ${B.name}`, item: url },
  ],
};

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  description,
  dateModified: c.updated,
  mainEntityOfPage: url,
  publisher: { "@type": "Organization", name: "Nova Raiz" },
};
---

<BaseLayout title={title} description={description}>
  <section class="py-10 md:py-14">
    <div class="mx-auto max-w-4xl">
      <nav class="text-xs" style="color: var(--muted);">
        <a class="underline" href="/">Home</a>
        <span class="mx-2">/</span>
        <a class="underline" href="/comparativas/">Comparativas</a>
        <span class="mx-2">/</span>
        <span>{A.name} vs {B.name}</span>
      </nav>

      <h1 class="mt-4 text-4xl md:text-5xl" style="font-family:'Playfair Display', serif;">
        {A.name} vs {B.name} (2026)
      </h1>
      <p class="mt-3 text-lg" style="color: var(--muted);">{description}</p>

      <div class="mt-2">
        <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)}></script>
        <script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)}></script>
      </div>

      <div class="mt-10 space-y-10">
        <div class="rounded-3xl border p-6" style="border-color: var(--border); background: var(--card);">
          <h2 class="text-2xl font-semibold">Tabela comparativa (dados oficiais + proxies)</h2>
          <p class="mt-2 text-sm" style="color: var(--muted);">
            População e PIB per capita vêm do IBGE (SIDRA). Os demais campos vêm do painel IBGE Cidades quando disponível. Onde não houver dado, aparece “—”.
          </p>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr style="color: var(--muted);">
                  <th class="py-2 text-left">Indicador</th>
                  <th class="py-2 text-left">{A.name}</th>
                  <th class="py-2 text-left">{B.name}</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">População (Censo 2022)</td>
                  <td class="py-2" style="color: var(--muted);">{fmt(cityA?.pop_2022)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmt(cityB?.pop_2022)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">PIB per capita (último ano IBGE)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtMoney(cityA?.pib_pc)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtMoney(cityB?.pib_pc)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">IDHM (2010)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.idhm_2010, 3)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.idhm_2010, 3)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Salário médio formal (salários mínimos)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.salario_medio_sm, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.salario_medio_sm, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Domicílios com Internet (%)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.domicilios_internet_pct, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.domicilios_internet_pct, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Taxa de escolarização 6–14 anos (%)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.escolarizacao_6a14_pct, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.escolarizacao_6a14_pct, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Área territorial (km²)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.area_km2, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.area_km2, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Densidade demográfica (hab/km²)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.densidade_demo, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.densidade_demo, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Esgoto adequado (%)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.esgoto_adequado_pct, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.esgoto_adequado_pct, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Arborização (%)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.arborizacao_pct, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.arborizacao_pct, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Mortalidade infantil (por mil)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.mortalidade_infantil_por_mil, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.mortalidade_infantil_por_mil, 2)}</td>
                </tr>
                <tr class="border-t" style="border-color: var(--border);">
                  <td class="py-2">Estab. saúde SUS (proxy por 100k)</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityA?.estab_saude_sus_100k, 2)}</td>
                  <td class="py-2" style="color: var(--muted);">{fmtNum(cityB?.estab_saude_sus_100k, 2)}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-xs" style="color: var(--muted);">
            Fonte: IBGE (SIDRA + Cidades e Estados). Em alguns municípios, o painel do IBGE não exibe todos os indicadores — nesses casos, o campo fica “—”.
          </div>
        </div>

        <div class="rounded-3xl border p-6" style="border-color: var(--border); background: var(--surface);">
          <h2 class="text-2xl font-semibold">Leia também</h2>
          <ul class="mt-3 list-disc pl-5 text-sm space-y-2" style="color: var(--muted);">
            <li><a class="underline" href="/mudar-para-o-interior-guia-definitivo/">Guia definitivo da mudança</a></li>
            <li><a class="underline" href="/checklist/">Checklist completo</a></li>
            <li><a class="underline" href="/blog/melhores-cidades-interior-brasil-2026/">Guia Mestre (Brasil)</a></li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
