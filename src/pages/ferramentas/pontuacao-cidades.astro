---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { CITY_METRICS_2026 } from "../../data/rankingData";

// slugs disponíveis em /cidades/ (para links clicáveis)
const cityPageModules = import.meta.glob("../cidades/*.astro", { eager: true });
const cityPageSlugs = Object.keys(cityPageModules).map((p) => p.split("/").pop()?.replace(/\.astro$/, "")).filter(Boolean);
---

<BaseLayout title="Sistema de pontuação — Nova Raiz" description="Ajuste os pesos do que importa e gere um ranking personalizado de cidades (beta).">
  <section class="py-10 md:py-14">
    <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <div>
        <h1 class="text-4xl md:text-5xl" style="font-family:'Playfair Display', serif;">Sistema de pontuação de cidades</h1>
        <p class="mt-4 text-lg" style="color: var(--muted);">
          Ajuste os pesos e gere um ranking de acordo com o seu perfil. (Beta — funciona melhor para comparar <strong>tendências</strong>, não “verdades absolutas”.)
        </p>
      </div>

      <div class="flex gap-2">
        <a href="/ranking/estados/" class="inline-flex items-center rounded-xl border px-4 py-2 text-sm font-semibold hover:opacity-95 transition"
           style="border-color: var(--border); background: var(--surface); color: var(--text);">
          Ver por estado
        </a>
        <button id="btnReset" type="button" class="inline-flex items-center rounded-xl border px-4 py-2 text-sm font-semibold hover:opacity-95 transition"
                style="border-color: var(--border); background: var(--card); color: var(--text);">
          Reset padrão
        </button>
      </div>
    </div>

    <div class="mt-8 grid gap-6 lg:grid-cols-3">
      <div class="rounded-3xl border p-6 lg:col-span-1" style="border-color: var(--border); background: var(--card);">
        <div class="text-sm font-semibold" style="color: var(--muted);">Configurar pesos</div>
        <p class="mt-2 text-sm" style="color: var(--muted);">
          Dica: mexa em 2–3 pesos por vez. O ranking muda em tempo real.
        </p>

        <div id="weightsBox" class="mt-6 space-y-4"></div>

        <div class="mt-6 rounded-2xl border p-4" style="border-color: var(--border); background: var(--surface);">
          <div class="text-xs font-semibold" style="color: var(--muted);">Como ler o resultado</div>
          <ul class="mt-2 list-disc pl-5 text-xs space-y-1" style="color: var(--muted);">
            <li><strong>Score</strong> é relativo ao conjunto de cidades do sistema.</li>
            <li>Empates são comuns quando pesos são parecidos.</li>
            <li>Use o ranking para <em>triagem</em> e depois leia guias e comparativas.</li>
          </ul>
        </div>
      </div>

      <div class="rounded-3xl border p-6 lg:col-span-2" style="border-color: var(--border); background: var(--surface);">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <div class="text-sm font-semibold" style="color: var(--muted);">Ranking personalizado</div>
            <div class="mt-1 text-xs" style="color: var(--muted);">
              Clique em uma cidade para abrir o guia (quando existir) ou buscar artigos no blog.
            </div>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-xs font-semibold" style="color: var(--muted);" for="limitSelect">Mostrar</label>
            <select id="limitSelect" class="rounded-xl border px-3 py-2 text-sm"
                    style="border-color: var(--border); background: var(--card); color: var(--text);">
              <option value="10">Top 10</option>
              <option value="20" selected>Top 20</option>
              <option value="40">Top 40</option>
              <option value="999">Todas</option>
            </select>
          </div>
        </div>

        <div class="mt-6 overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left">
                <th class="pb-3 pr-4" style="color: var(--muted);">#</th>
                <th class="pb-3 pr-4" style="color: var(--muted);">Cidade</th>
                <th class="pb-3 pr-4" style="color: var(--muted);">UF</th>
                <th class="pb-3 pr-4" style="color: var(--muted);">Score</th>
                <th class="pb-3 pr-4" style="color: var(--muted);">Notas rápidas</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script define:vars={{ data: CITY_METRICS_2026, cityPageSlugs }}>
    const DEFAULT_WEIGHTS = {
      custoDeVida: 18,
      seguranca: 20,
      internet: 10,
      saude: 10,
      educacao: 10,
      trabalho: 12,
      mobilidade: 8,
      clima: 6,
      lazer: 6
    };

    const LABELS = {
      custoDeVida: "Custo de vida",
      seguranca: "Segurança",
      internet: "Internet",
      saude: "Saúde",
      educacao: "Educação",
      trabalho: "Trabalho",
      mobilidade: "Mobilidade",
      clima: "Clima",
      lazer: "Lazer"
    };

    const EXPLAIN = {
      custoDeVida: "Custo mensal, aluguel e serviços (tendência).",
      seguranca: "Indicadores e percepção de risco (tendência).",
      internet: "Oferta de fibra/ISPs e estabilidade (tendência).",
      saude: "Acesso a rede privada e regional (tendência).",
      educacao: "Qualidade e oferta básica/privada (tendência).",
      trabalho: "Oportunidades locais + proximidade regional (tendência).",
      mobilidade: "Acesso rodoviário e deslocamentos (tendência).",
      clima: "Conforto térmico e extremos (tendência).",
      lazer: "Cultura, gastronomia e opções (tendência)."
    };

    // Normaliza índices (0..100). Se um índice vier ausente, assume 50 (neutro).
    function idx(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 50;
    }

    function getWeightsFromUI() {
      const w = {};
      Object.keys(DEFAULT_WEIGHTS).forEach((k) => {
        const el = document.querySelector(`[data-weight="${k}"]`);
        w[k] = el ? Number(el.value) : DEFAULT_WEIGHTS[k];
      });
      return w;
    }

    function scoreCity(city, w) {
      const total =
        idx(city.indices?.custoDeVida) * w.custoDeVida +
        idx(city.indices?.seguranca) * w.seguranca +
        idx(city.indices?.internet) * w.internet +
        idx(city.indices?.saude) * w.saude +
        idx(city.indices?.educacao) * w.educacao +
        idx(city.indices?.trabalho) * w.trabalho +
        idx(city.indices?.mobilidade) * w.mobilidade +
        idx(city.indices?.clima) * w.clima +
        idx(city.indices?.lazer) * w.lazer;

      const sumW = Object.values(w).reduce((a, b) => a + b, 0) || 1;
      // score 0..100
      return total / sumW;
    }

    function cityHref(city) {
      // prioridade: páginas pilar em /cidades/<slug>/
      if (Array.isArray(cityPageSlugs) && cityPageSlugs.includes(city.slug)) {
        return `/cidades/${city.slug}/`;
      }
      // fallback: levar ao blog (busca simples por querystring — mesmo se não filtrar, ainda é útil)
      const q = encodeURIComponent(city.city);
      return `/blog/?q=${q}`;
    }

    function quickNotes(city) {
      const s = idx(city.indices?.seguranca);
      const c = idx(city.indices?.custoDeVida);
      const i = idx(city.indices?.internet);
      const t = idx(city.indices?.trabalho);

      const notes = [];
      if (s >= 70) notes.push("segurança forte");
      if (s <= 40) notes.push("atenção segurança");
      if (c >= 70) notes.push("custo favorável");
      if (c <= 40) notes.push("custo alto");
      if (i >= 70) notes.push("internet boa");
      if (t >= 70) notes.push("trabalho/região forte");
      return notes.slice(0, 3).join(" • ") || "perfil equilibrado";
    }

    function renderWeights() {
      const box = document.getElementById("weightsBox");
      box.innerHTML = "";

      Object.keys(DEFAULT_WEIGHTS).forEach((k) => {
        const wrap = document.createElement("div");
        wrap.className = "rounded-2xl border p-4";
        wrap.style.borderColor = "var(--border)";
        wrap.style.background = "var(--surface)";

        wrap.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">${LABELS[k]}</div>
              <div class="mt-1 text-xs" style="color: var(--muted);">${EXPLAIN[k]}</div>
            </div>
            <div class="text-sm font-semibold" data-weight-value="${k}" style="color: var(--accent);">${DEFAULT_WEIGHTS[k]}</div>
          </div>

          <input class="mt-3 w-full"
                 type="range"
                 min="0" max="30" step="1"
                 value="${DEFAULT_WEIGHTS[k]}"
                 data-weight="${k}" />
        `;

        box.appendChild(wrap);
      });
    }

    function attachWeightListeners() {
      Object.keys(DEFAULT_WEIGHTS).forEach((k) => {
        const input = document.querySelector(`[data-weight="${k}"]`);
        input.addEventListener("input", () => {
          const val = Number(input.value);
          const label = document.querySelector(`[data-weight-value="${k}"]`);
          if (label) label.textContent = String(val);
          buildRows();
        });
      });
    }

    function buildRows() {
      const w = getWeightsFromUI();
      const limit = Number(document.getElementById("limitSelect").value) || 20;

      const ranked = [...data]
        .map((c) => ({ ...c, _score: scoreCity(c, w) }))
        .sort((a, b) => b._score - a._score);

      const rows = document.getElementById("rows");
      rows.innerHTML = "";

      ranked.slice(0, limit).forEach((c, i) => {
        const tr = document.createElement("tr");
        tr.className = "border-t hover:opacity-95 transition cursor-pointer";
        tr.style.borderColor = "var(--border)";
        tr.setAttribute("data-href", cityHref(c));

        tr.innerHTML = `
          <td class="py-3 pr-4" style="color: var(--muted);">${i + 1}</td>
          <td class="py-3 pr-4 font-semibold">${c.city}</td>
          <td class="py-3 pr-4" style="color: var(--muted);">${c.uf}</td>
          <td class="py-3 pr-4 font-semibold" style="color: var(--accent);">${c._score.toFixed(1)}</td>
          <td class="py-3 pr-4 text-xs" style="color: var(--muted);">${quickNotes(c)}</td>
        `;

        tr.addEventListener("click", () => {
          const href = tr.getAttribute("data-href");
          if (href) window.location.href = href;
        });

        rows.appendChild(tr);
      });
    }

    function resetDefaults() {
      Object.keys(DEFAULT_WEIGHTS).forEach((k) => {
        const input = document.querySelector(`[data-weight="${k}"]`);
        if (input) input.value = String(DEFAULT_WEIGHTS[k]);
        const label = document.querySelector(`[data-weight-value="${k}"]`);
        if (label) label.textContent = String(DEFAULT_WEIGHTS[k]);
      });
      buildRows();
    }

    // init
    renderWeights();
    attachWeightListeners();
    buildRows();

    document.getElementById("btnReset")?.addEventListener("click", (e) => {
      e.preventDefault();
      resetDefaults();
    });

    document.getElementById("limitSelect")?.addEventListener("change", () => buildRows());
  </script>
</BaseLayout>
